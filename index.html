<!doctype html>
<html lang="de">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<link
			href="./services/rest/paths/print/font/jersey20.woff2"
			rel="stylesheet"
		/>
		<link rel="stylesheet" href="./index.css" />
		<title>Ideenwürfel</title>
	</head>
	<body>
		<main>
			<div class="heading">
				<h1>Ideenwürfel</h1>
				<img
					src="https://logos.citylab-berlin.org/logo-citylab-color.svg"
					alt="CityLab Logo"
					width="120px"
				/>
			</div>
			<div>
				Nach Anpassung der Labels, bitte <b>speichern</b> am Ende der Seite
				klicken.
			</div>
			<form id="form">
				<div class="focus-group-container">
					<div class="group-a">
						<h3 class="focus-group">Würfel A: Fokus Gruppe</h3>
						<div id="status-A" style="padding-bottom: 10px"></div>

						<!--A1-->
						<div class="label-block">
							<label for="A1">A1</label>
							<input type="text" name="A1" id="A1" />
						</div>

						<!--A2-->
						<div class="label-block">
							<label for="A2">A2</label>
							<input type="text" name="A2" id="A2" />
						</div>

						<!--A3-->
						<div class="label-block">
							<label for="A3">A3</label>
							<input type="text" name="A3" id="A3" />
						</div>

						<!--A4-->
						<div class="label-block">
							<label for="A4">A4</label>
							<input type="text" name="A4" id="A4" />
						</div>

						<!--A5-->
						<div class="label-block">
							<label for="A5">A5</label>
							<input type="text" name="A5" id="A5" />
						</div>

						<!--A6-->
						<div class="label-block">
							<label for="A6">A6</label>
							<input type="text" name="A6" id="A6" />
						</div>
					</div>

					<div class="group-b">
						<h3 class="topic">Würfel B: Thema</h3>
						<div id="status-B" style="padding-bottom: 10px"></div>

						<!--B1-->
						<div class="label-block">
							<label for="B1">B1</label>
							<input type="text" name="B1" id="B1" />
						</div>

						<!--B2-->
						<div class="label-block">
							<label for="B2">B2</label>
							<input type="text" name="B2" id="B2" />
						</div>

						<!--B3-->
						<div class="label-block">
							<label for="B3">B3</label>
							<input type="text" name="B3" id="B3" />
						</div>

						<!--B4-->
						<div class="label-block">
							<label for="B4">B4</label>
							<input type="text" name="B4" id="B4" />
						</div>

						<!--B5-->
						<div class="label-block">
							<label for="B5">B5</label>
							<input type="text" name="B5" id="B5" />
						</div>

						<!--B6-->
						<div class="label-block">
							<label for="B6">B6</label>
							<input type="text" name="B6" id="B6" />
						</div>
					</div>

					<div class="group-c">
						<h3 class="medium">Würfel C: Medium</h3>
						<div id="status-C" style="padding-bottom: 10px"></div>

						<!--C1-->
						<div class="label-block">
							<label for="C1">C1</label>
							<input type="text" name="C1" id="C1" />
						</div>

						<!--C2-->
						<div class="label-block">
							<label for="C2">C2</label>
							<input type="text" name="C2" id="C2" />
						</div>

						<!--C3-->
						<div class="label-block">
							<label for="C3">C3</label>
							<input type="text" name="C3" id="C3" />
						</div>

						<!--C4-->
						<div class="label-block">
							<label for="C4">C4</label>
							<input type="text" name="C4" id="C4" />
						</div>

						<!--C5-->
						<div class="label-block">
							<label for="C5">C5</label>
							<input type="text" name="C5" id="C5" />
						</div>

						<!--C6-->
						<div class="label-block">
							<label for="C6">C6</label>
							<input type="text" name="C6" id="C6" />
						</div>
					</div>
				</div>
				<button type="submit">Speichern</button>
			</form>
		</main>

		<template id="connected">
			<div
				style="
					display: flex;
					flex-direction: row;
					gap: 10px;
					align-items: center;
					color: #2d8c64;
					padding: 0.5rem 1rem;
					border: 1px solid #2d8c64;
				"
			>
				<svg
					xmlns="http://www.w3.org/2000/svg"
					fill="none"
					viewBox="0 0 24 24"
					stroke-width="1.5"
					stroke="currentColor"
					style="width: 1.5rem; height: 1.5rem"
				>
					<path
						stroke-linecap="round"
						stroke-linejoin="round"
						d="M9 12.75 11.25 15 15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"
					/>
				</svg>

				<span id="status-connected-text">Verbunden</span>
			</div>
		</template>

		<template id="disconnected">
			<div
				style="
					display: flex;
					flex-direction: row;
					gap: 10px;
					align-items: center;
					color: #f4a203;
					padding: 0.5rem 1rem;
					border: 1px solid #f4a203;
				"
			>
				<svg
					xmlns="http://www.w3.org/2000/svg"
					fill="none"
					viewBox="0 0 24 24"
					stroke-width="1.5"
					stroke="currentColor"
					style="width: 1.5rem; height: 1.5rem"
				>
					<path
						stroke-linecap="round"
						stroke-linejoin="round"
						d="m9.75 9.75 4.5 4.5m0-4.5-4.5 4.5M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"
					/>
				</svg>
				<span>Getrennt</span>
			</div>
		</template>
	</body>
	<script type="text/javascript">
		function onSubmit(event) {
			event.preventDefault();

			const labels = {};

			for (const input of event.target) {
				if (!input.id) {
					continue;
				}

				labels[input.id] = input.value;
			}

			fetch("http://localhost:8000/labels", {
				body: JSON.stringify({ labels }),
				method: "PUT",
			})
				.then((response) => response.json())
				.then((data) => console.log(data))
				.catch((error) => console.error(error));
		}

		const form = document.getElementById("form");
		form.addEventListener("submit", onSubmit);

		fetch("http://localhost:8000/labels")
			.then((response) => response.json())
			.then(({ labels }) => {
				for (const [key, value] of Object.entries(labels)) {
					document.getElementById(key).value = value;
				}
			})
			.catch((error) => console.error(error));
	</script>
	<script type="text/javascript">
		let savedLabels = {};

		let webSocket = null;

		function connect() {
			try {
				webSocket = new WebSocket("ws://localhost:8001");
			} catch (error) {
				console.error(error);
				webSocket = null;
			}

			if (!webSocket) {
				return;
			}

			webSocket.addEventListener("open", () =>
				console.log("Connected via WebSocket"),
			);
			webSocket.addEventListener("close", () => {
				console.log("Disconnected from WebSocket");
				setTimeout(() => initialize(), 5000);
			});

			webSocket.addEventListener("message", (event) => {
				const { dices } = JSON.parse(event.data);

				fetch("http://localhost:8000/labels")
					.then((response) => response.json())
					.then(({ labels }) => {
						savedLabels = labels;
					})
					.then(() => updateStatus(dices))
					.catch((error) => console.error(error));
			});
		}

		function updateStatus(dices) {
			for (const [key, dice] of Object.entries(dices)) {
				const statusDiv = document.getElementById(`status-${key}`);
				statusDiv.innerHTML = "";
				statusDiv.appendChild(
					createConnectionStatusElement(
						key,
						dice,
						savedLabels[`${key + dice.side}`],
					),
				);
			}
		}

		function createConnectionStatusElement(key, dice, label) {
			switch (dice.status) {
				case "connected":
					return cloneConnectedTemplate(key, dice.side, label);
				default:
					return cloneDisconnectedTemplate();
			}
		}

		function cloneConnectedTemplate(key, side, label) {
			const connectedTemplate = document.getElementById("connected");
			const clone = connectedTemplate.content.cloneNode(true);

			const statusText = clone.getElementById("status-connected-text");
			statusText.innerHTML = `Verbunden, ${side !== null ? `Würfelseite oben: <br/> <b>${key}${side}:</b> ${label}` : "einmal Würfeln bitte!"}`;

			return clone;
		}

		function cloneDisconnectedTemplate() {
			const disconnectedTemplate = document.getElementById("disconnected");
			return disconnectedTemplate.content.cloneNode(true);
		}

		function initialize() {
			updateStatus({
				A: { status: "disconnected" },
				B: { status: "disconnected" },
				C: { status: "disconnected" },
			});
			connect();
		}

		initialize();
	</script>
</html>
